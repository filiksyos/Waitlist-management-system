<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receptionist Queue Manager - Mebrej Clinic</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #4682B4;
      margin: 0;
    }
    
    .queue-manager-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .doctor-section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .doctor-section h2 {
      background-color: #4682B4;
      color: white;
      padding: 15px;
      margin: -20px -20px 20px -20px;
      border-radius: 10px 10px 0 0;
      text-align: center;
    }
    
    .add-patient-form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    
    .add-patient-form input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .add-patient-form input[type="text"] {
      flex: 1;
    }
    
    .add-patient-form input[type="number"] {
      width: 80px;
    }
    
    .add-patient-form button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .add-patient-form button:hover {
      background-color: #3e8e41;
    }
    
    .queue-list {
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .patient-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }
    
    .patient-item:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .position-number {
      font-weight: bold;
      color: #4682B4;
      min-width: 30px;
    }
    
    .patient-name {
      flex: 1;
      font-size: 16px;
    }
    
    .patient-actions {
      display: flex;
      gap: 5px;
    }
    
    .edit-btn {
      padding: 4px 8px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .edit-btn:hover {
      background-color: #3e8e41;
    }
    
    .switch-btn {
      padding: 4px 8px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .switch-btn:hover {
      background-color: #1976D2;
    }
    
    .remove-btn {
      padding: 4px 8px;
      background-color: #d32f2f;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .remove-btn:hover {
      background-color: #b71c1c;
    }
    
    .empty-message {
      text-align: center;
      color: #888;
      font-style: italic;
      padding: 40px 20px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìã Receptionist Queue Manager</h1>
  </div>
  
  <div class="queue-manager-container">
    <div class="doctor-section">
      <h2>Doctor 1 Queue</h2>
      <div class="add-patient-form">
        <input type="text" id="doctor1Name" placeholder="Patient Name" required>
        <input type="number" id="doctor1Position" placeholder="Position" min="1" value="">
        <button onclick="addPatient('doctor1')">Add</button>
      </div>
      <div class="queue-list" id="doctor1Queue">
        <!-- Patient list for doctor 1 -->
      </div>
    </div>
    
    <div class="doctor-section">
      <h2>Doctor 2 Queue</h2>
      <div class="add-patient-form">
        <input type="text" id="doctor2Name" placeholder="Patient Name" required>
        <input type="number" id="doctor2Position" placeholder="Position" min="1" value="">
        <button onclick="addPatient('doctor2')">Add</button>
      </div>
      <div class="queue-list" id="doctor2Queue">
        <!-- Patient list for doctor 2 -->
      </div>
    </div>
  </div>

  <script src="client.js"></script>
  <script>
    // Update position input placeholders to show next available position
    function updatePositionPlaceholders() {
      let patients = [];
      try {
        const stored = localStorage.getItem('patients');
        if (stored) {
          patients = JSON.parse(stored);
        }
      } catch (e) {
        console.error('Error loading patients:', e);
      }
      
      // Update Doctor 1 placeholder
      const doctor1Patients = patients.filter(patient => patient.doctorId === 'doctor1');
      const doctor1NextPosition = doctor1Patients.length + 1;
      document.getElementById('doctor1Position').placeholder = `Position (default: ${doctor1NextPosition})`;
      
      // Update Doctor 2 placeholder
      const doctor2Patients = patients.filter(patient => patient.doctorId === 'doctor2');
      const doctor2NextPosition = doctor2Patients.length + 1;
      document.getElementById('doctor2Position').placeholder = `Position (default: ${doctor2NextPosition})`;
    }
    
    // Load and display both doctor queues
    function loadQueues() {
      let patients = [];
      try {
        const stored = localStorage.getItem('patients');
        if (stored) {
          patients = JSON.parse(stored);
        }
      } catch (e) {
        console.error('Error loading patients:', e);
      }
      
      renderDoctorQueue('doctor1', patients);
      renderDoctorQueue('doctor2', patients);
      updatePositionPlaceholders();
    }
    
    // Render a single doctor's queue
    function renderDoctorQueue(doctorId, allPatients) {
      const queueContainer = document.getElementById(doctorId + 'Queue');
      
      // Filter patients for this doctor
      const doctorPatients = allPatients.filter(patient => patient.doctorId === doctorId);
      
      // Clear current content
      queueContainer.innerHTML = '';
      
      if (doctorPatients.length === 0) {
        queueContainer.innerHTML = '<div class="empty-message">No patients in queue</div>';
        return;
      }
      
      // Render each patient
      doctorPatients.forEach((patient, index) => {
        const patientDiv = document.createElement('div');
        patientDiv.className = 'patient-item';
        patientDiv.innerHTML = `
          <span class="position-number">${index + 1}.</span>
          <span class="patient-name">${patient.patientName || 'Unknown'}</span>
          <div class="patient-actions">
            <button class="edit-btn" onclick="editPatientPosition('${doctorId}', ${index})" title="Change position">‚úèÔ∏è</button>
            <button class="switch-btn" onclick="switchDoctorQuick('${doctorId}', ${index})" title="Switch doctor">üîÑ</button>
            <button class="remove-btn" onclick="removePatient('${doctorId}', ${index})" title="Remove">üóëÔ∏è</button>
          </div>
        `;
        queueContainer.appendChild(patientDiv);
      });
    }
    
    // Add patient at specified position
    function addPatient(doctorId) {
      const nameInput = document.getElementById(doctorId + 'Name');
      const positionInput = document.getElementById(doctorId + 'Position');
      
      const patientName = nameInput.value.trim();
      
      // Load current patients to determine queue length
      let allPatients = [];
      try {
        const stored = localStorage.getItem('patients');
        if (stored) {
          allPatients = JSON.parse(stored);
        }
      } catch (e) {
        console.error('Error loading patients:', e);
      }
      
      // Filter patients for this doctor to get current queue length
      const currentDoctorPatients = allPatients.filter(patient => patient.doctorId === doctorId);
      
      // If no position specified, default to end of queue (last position + 1)
      const position = parseInt(positionInput.value) || (currentDoctorPatients.length + 1);
      
      if (!patientName) {
        alert('Please enter a patient name');
        return;
      }
      
      // Filter patients for this doctor
      const doctorPatients = currentDoctorPatients;
      const otherPatients = allPatients.filter(patient => patient.doctorId !== doctorId);
      
      // Create new patient object
      const newPatient = {
        cardNumber: '',
        date: new Date().toISOString().split('T')[0],
        patientName: patientName,
        age: '',
        sex: '',
        address: '',
        wereda: '',
        kebele: '',
        phoneNumber: '',
        doctorId: doctorId,
        createdAt: new Date().toISOString()
      };
      
      // Insert at specified position (1-based to 0-based)
      const insertIndex = Math.max(0, Math.min(position - 1, doctorPatients.length));
      doctorPatients.splice(insertIndex, 0, newPatient);
      
      // Combine all patients back together
      const updatedPatients = [...otherPatients, ...doctorPatients];
      
      // Update localStorage
      localStorage.setItem('patients', JSON.stringify(updatedPatients));
      
      // Clear inputs and update position placeholder
      nameInput.value = '';
      positionInput.value = '';
      updatePositionPlaceholders();
      
      // Refresh display
      loadQueues();
      
      // Force queue update with enhanced broadcasting
      forceQueueUpdate(updatedPatients, 'addPatient');
    }
    
    // Remove patient with confirmation
    function removePatient(doctorId, index) {
      // Load current patients
      let patients = [];
      try {
        const stored = localStorage.getItem('patients');
        if (stored) {
          patients = JSON.parse(stored);
        }
      } catch (e) {
        console.error('Error loading patients:', e);
        return;
      }
      
      // Filter patients for this doctor
      const doctorPatients = patients.filter(patient => patient.doctorId === doctorId);
      const otherPatients = patients.filter(patient => patient.doctorId !== doctorId);
      
      if (index >= 0 && index < doctorPatients.length) {
        const patient = doctorPatients[index];
        
        // Show confirmation dialog
        if (confirm(`Remove ${patient.patientName} from the queue?`)) {
          // Remove patient from array
          doctorPatients.splice(index, 1);
          
          // Combine all patients back together
          const updatedPatients = [...otherPatients, ...doctorPatients];
          
          // Update localStorage
          localStorage.setItem('patients', JSON.stringify(updatedPatients));
          
          // Refresh display
          loadQueues();
          
          // Force queue update with enhanced broadcasting
          forceQueueUpdate(updatedPatients, 'removePatient');
        }
      }
    }
    
    // Edit patient position only (simplified)
    function editPatientPosition(doctorId, index) {
      // Load current patients
      let patients = [];
      try {
        const stored = localStorage.getItem('patients');
        if (stored) {
          patients = JSON.parse(stored);
        }
      } catch (e) {
        console.error('Error loading patients:', e);
        return;
      }
      
      // Filter patients for this doctor
      const doctorPatients = patients.filter(patient => patient.doctorId === doctorId);
      
      if (index >= 0 && index < doctorPatients.length) {
        const patient = doctorPatients[index];
        
        // Ask for new position
        const newPosition = prompt(`Enter new position for ${patient.patientName} (current: ${index + 1}):`);
        if (newPosition === null) return; // User cancelled
        
        const position = parseInt(newPosition);
        if (isNaN(position) || position < 1) {
          alert('Please enter a valid position (1 or higher)');
          return;
        }
        
        // Remove patient from current position
        const otherPatients = patients.filter(p => p.doctorId !== doctorId);
        const patientToMove = doctorPatients.splice(index, 1)[0];
        
        // Insert at new position
        const insertIndex = Math.max(0, Math.min(position - 1, doctorPatients.length));
        doctorPatients.splice(insertIndex, 0, patientToMove);
        
        // Combine all patients back together
        const updatedPatients = [...otherPatients, ...doctorPatients];
        
        // Update localStorage
        localStorage.setItem('patients', JSON.stringify(updatedPatients));
        
        // Refresh display
        loadQueues();
        
        // Force queue update with enhanced broadcasting
        forceQueueUpdate(updatedPatients, 'editPosition');
      }
    }
    
    // Quick doctor switch function
    function switchDoctorQuick(doctorId, index) {
      // Load current patients
      let patients = [];
      try {
        const stored = localStorage.getItem('patients');
        if (stored) {
          patients = JSON.parse(stored);
        }
      } catch (e) {
        console.error('Error loading patients:', e);
        return;
      }
      
      // Filter patients for this doctor
      const doctorPatients = patients.filter(patient => patient.doctorId === doctorId);
      
      if (index >= 0 && index < doctorPatients.length) {
        const patient = doctorPatients[index];
        
        // Determine target doctor (switch to opposite)
        const newDoctorId = doctorId === 'doctor1' ? 'doctor2' : 'doctor1';
        const doctorName = newDoctorId === 'doctor1' ? 'Doctor 1' : 'Doctor 2';
        
        // Confirm the switch
        if (!confirm(`Switch ${patient.patientName} to ${doctorName}'s queue?`)) {
          return;
        }
        
        // Remove patient from current doctor's list
        const allOtherPatients = patients.filter(p => !(p.doctorId === doctorId && p.createdAt === patient.createdAt));
        
        // Update patient's doctor
        patient.doctorId = newDoctorId;
        
        // Get target doctor's patients and add to end
        const targetDoctorPatients = allOtherPatients.filter(p => p.doctorId === newDoctorId);
        targetDoctorPatients.push(patient);
        
        // Get all other patients (not from target doctor)
        const otherPatients = allOtherPatients.filter(p => p.doctorId !== newDoctorId);
        
        // Combine all patients
        const updatedPatients = [...otherPatients, ...targetDoctorPatients];
        
        // Update localStorage
        localStorage.setItem('patients', JSON.stringify(updatedPatients));
        
        // Refresh display
        loadQueues();
        
        // Force queue update with enhanced broadcasting
        forceQueueUpdate(updatedPatients, 'switchDoctor');
      }
    }
    
    // Enhanced WebSocket broadcasting function
    function forceQueueUpdate(updatedPatients, source = 'unknown') {
      console.log(`üîÑ [${source}] Forcing queue update with`, updatedPatients.length, 'patients');
      console.log(`üìã [${source}] Patient data:`, updatedPatients);
      
      // Update localStorage FIRST
      localStorage.setItem('patients', JSON.stringify(updatedPatients));
      console.log(`üíæ [${source}] Updated localStorage`);
      
      // Check WebSocket status and connection
      console.log(`üåê WebSocket status: ${window.ws ? window.ws.readyState : 'not available'}`);
      console.log(`üì° broadcastQueueUpdate available: ${typeof broadcastQueueUpdate}`);
      
      // STEP 1: Immediate WebSocket send (this is critical)
      if (window.ws && window.ws.readyState === WebSocket.OPEN) {
        console.log(`‚ö° Immediate WebSocket send`);
        try {
          window.ws.send(JSON.stringify({ 
            type: 'update', 
            patients: updatedPatients,
            source: source,
            timestamp: new Date().toISOString()
          }));
          console.log(`‚ö° Immediate WebSocket send completed`);
        } catch (e) {
          console.error(`‚ùå Immediate WebSocket send failed:`, e);
        }
      } else {
        console.warn(`‚ö†Ô∏è WebSocket not ready for immediate send`);
      }
      
      // STEP 2: Custom event for local listeners
      try {
        window.dispatchEvent(new CustomEvent('queueUpdated', { 
          detail: { patients: updatedPatients, source: source }
        }));
        console.log(`üì¢ Custom event dispatched`);
      } catch (e) {
        console.error(`‚ùå Custom event failed:`, e);
      }
      
      // STEP 3: Use standard broadcastQueueUpdate function
      if (typeof broadcastQueueUpdate === 'function') {
        console.log(`‚úÖ Broadcasting via broadcastQueueUpdate`);
        try {
          broadcastQueueUpdate();
          console.log(`‚úÖ broadcastQueueUpdate completed`);
        } catch (e) {
          console.error(`‚ùå broadcastQueueUpdate failed:`, e);
        }
      }
      
      // STEP 4: Direct WebSocket with extra payload
      if (window.ws && window.ws.readyState === WebSocket.OPEN) {
        console.log(`‚úÖ Broadcasting via direct WebSocket`);
        try {
          window.ws.send(JSON.stringify({ 
            type: 'update', 
            patients: updatedPatients,
            source: source,
            timestamp: new Date().toISOString(),
            forceUpdate: true
          }));
          console.log(`‚úÖ Direct WebSocket send completed`);
        } catch (e) {
          console.error(`‚ùå Direct WebSocket send failed:`, e);
        }
      }
      
      // STEP 5: Local renderQueue trigger
      if (typeof window.renderQueue === 'function') {
        console.log(`‚úÖ Triggering renderQueue directly`);
        try {
          window.renderQueue(updatedPatients);
          console.log(`‚úÖ renderQueue completed`);
        } catch (e) {
          console.error(`‚ùå renderQueue failed:`, e);
        }
      }
    }
    
    // WebSocket integration - this will be called by client.js when updates arrive
    window.renderQueue = function(patients) {
      if (patients && Array.isArray(patients)) {
        // Update localStorage
        localStorage.setItem('patients', JSON.stringify(patients));
        
        // Refresh display
        renderDoctorQueue('doctor1', patients);
        renderDoctorQueue('doctor2', patients);
        updatePositionPlaceholders();
      }
    };
    
    // Initialize page when loaded
    window.onload = function() {
      loadQueues();
    };
  </script>
</body>
</html> 